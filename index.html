<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>detect-caps-lock</title>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>

<script type="module">
  import { render, h } from "https://cdn.skypack.dev/preact";
  import { useEffect, useState } from "https://cdn.skypack.dev/preact/hooks";

  const useCapsLockDetection = () => {
    const [capsLockIsOn, setCapsLockIsOn] = useState(false);

    const onKeyDown = (e) => {
      const isCapsLockModifier = e.getModifierState("CapsLock");
      const isCapsLockKey = e.key === "CapsLock";

      setCapsLockIsOn(isCapsLockModifier !== isCapsLockKey);
    };

    useEffect(() => {
      document.addEventListener("keydown", onKeyDown);
      return () => document.removeEventListener("keydown", onKeyDown);
    }, []);

    return capsLockIsOn;
  };

  const useVisibilityDetection = () => {
    const [isVisible, setIsVisible] = useState(true);

    const onVisibilityChange = () => {
      setIsVisible(!document.hidden);
    };

    useEffect(() => {
      document.addEventListener("visibilitychange", onVisibilityChange);
      return () =>
        document.removeEventListener("visibilitychange", onVisibilityChange);
    }, []);

    return isVisible;
  };

  const useLockOnLeave = () => {
    const [isLocked, setIsLocked] = useState(false);
    const isVisible = useVisibilityDetection();

    useEffect(() => {
      if (!isVisible) {
        setIsLocked(true)
      }
    }, [isVisible]);

    const unlock = () => setIsLocked(false);

    return [isLocked, unlock];
  };

  const CapsLockIndicator = ({capsLockIsOn}) => {
    return h(
      "div",
      {},
      "caps lock is ",
      h("strong", {}, capsLockIsOn ? "ON" : "OFF")
    );
  };

  const UnlockPrompt = ({unlock}) => {
    useEffect(() => {
      document.addEventListener("keypress", unlock);
      return () => document.removeEventListener("keypress", unlock);
    });

    return h("div", {}, "Press any key to continue")
  };

  const App = () => {
    const capsLockIsOn = useCapsLockDetection();
    const [isLocked, unlock] = useLockOnLeave();

    return isLocked
      ? h(UnlockPrompt, { unlock })
      : h(CapsLockIndicator, { capsLockIsOn });
  };

  render(h(App), document.getElementById("app"));
</script>
